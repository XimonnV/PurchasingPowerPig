<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchasing Power Pig</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Banner image at top center -->
    <div class="banner-container scaled-element">
        <img src="ppp-banner.png" alt="Purchasing Power Pig Banner">
    </div>
    
    <!-- Pig image container -->
    <div class="pig-container scaled-element">
        <img src="piggy.png" alt="Piggy Bank">
    </div>
    
    <!-- Banker image container -->
    <div class="banker-container scaled-element">
        <img src="banker.png" alt="Banker">
    </div>
    
    <!-- Banker's mug container -->
    <div class="banker-mug-container scaled-element">
        <div class="banker-mug-fill"></div>
    </div>
    
    <!-- Invisible oval container for drop fill effect -->
    <div class="pig-oval-container scaled-element">
        <div class="pig-oval-fill"></div>
    </div>
    
    <!-- Percentage display centered on pig -->
    <div class="pig-percentage scaled-element" id="pigPercentageDisplay">0%</div>
    
    <!-- Panel container for right-side panels with automatic spacing -->
    <div class="panel-container">
        <div class="controls">
            <div class="control-group">
                <label>Monthly Savings: $<span id="savingsValue">100</span></label>
                <div class="slider-row">
                    <input type="range" id="savings" min="0" max="1000" value="100" step="10">
                    <button id="balanceSavings" class="balance-button" aria-label="Balance"></button>
                </div>
            </div>
            
            <div class="control-group">
                <label>Starting Amount: $<span id="startAmountValue">50000</span></label>
                <div class="slider-row">
                    <input type="range" id="startAmount" min="0" max="100000" value="50000" step="1000">
                    <button id="balanceStartAmount" class="balance-button" aria-label="Balance"></button>
                </div>
            </div>
            
            <div class="control-group">
                <label class="label-deemphasized"><i>Purchasing Power loss</i></label>
                <label>Debasement + CPI: <span id="inflationValue">7</span>%</label>
                <div class="slider-row">
                    <input type="range" id="inflation" min="5" max="20" value="7" step="0.1">
                    <button id="balanceInflation" class="balance-button" aria-label="Balance"></button>
                </div>
            </div>
            
            <div class="control-group">
                <button id="restartButton">Restart</button>
                <button id="pauseButton">Pause</button>
            </div>
        </div>

        <!-- Savings display panel -->
        <div class="savings-display">
            <div class="savings-label">Date: <span id="currentDateValue">2025 October</span></div>
            <div class="savings-label">Savings: <span id="totalSavingsValue">$0</span></div>
            <div class="savings-label">PP <span id="ppStartDate">2025-10</span>: <span id="ppValue">$0</span></div>
            <div class="savings-label">PP Lost: <span id="totalBankValue">0%</span></div>
        </div>

        <!-- Info panel -->
        <div class="info-display">
            <div class="info-text">A full pig equals the purchasing power of $100K at 2025 October</div>
        </div>
    </div>

    <!-- Debug display (hidden by default - remove style="display:none" to show) -->
    <div class="debug-display" style="display: none;">
        Pig: <span id="debugFillValue">0.00</span>%<br>
        Mug: <span id="debugMugValue">0.00</span>%<br>
        Bank $: <span id="debugBankDollars">$0</span>
    </div>

    <!-- Load JavaScript modules in dependency order -->
    <!-- 1. CONFIG - must load first -->
    <script src="config.js"></script>
    
    <!-- 2. Financial Math - uses CONFIG -->
    <script src="financial-math.js"></script>
    
    <!-- 3. DOM Cache - uses CONFIG -->
    <script src="dom-cache.js"></script>
    
    <!-- 4. State Manager - uses CONFIG, settingsCache, and financial-math functions -->
    <script src="state-manager.js"></script>
    
    <!-- 5. UI Control Logic (inline) -->
    <script>
        // Function to set balance icon for all three buttons
        function setBalanceIcon(iconFile, flipHorizontal = false) {
            const buttons = [
                document.getElementById('balanceStartAmount'),
                document.getElementById('balanceInflation'),
                document.getElementById('balanceSavings')
            ];
            buttons.forEach(button => {
                if (button) {
                    button.style.backgroundImage = `url('${iconFile}')`;
                    // Apply horizontal flip using CSS transform
                    if (flipHorizontal) {
                        button.style.transform = 'scaleX(-1)';
                    } else {
                        button.style.transform = 'scaleX(1)';
                    }
                }
            });
        }
        
        // Function to check if values are balanced
        function checkBalance() {
            const currentStartAmount = parseInt(document.getElementById('startAmount').value);
            const currentInflation = parseFloat(document.getElementById('inflation').value);
            const currentSavings = parseInt(document.getElementById('savings').value);
            
            // Get balance state from financial-math.js
            const balanceState = getBalanceState(currentStartAmount, currentSavings, currentInflation);
            
            // Update icon based on state
            if (balanceState === CONFIG.balanceStates.BALANCED) {
                // Balanced: show balance icon (no flip)
                setBalanceIcon(CONFIG.images.balance, false);
            } else if (balanceState === CONFIG.balanceStates.GROW) {
                // Growing: show tilted icon (no flip - tilts right)
                setBalanceIcon(CONFIG.images.balanceTilt, false);
            } else if (balanceState === CONFIG.balanceStates.SHRINK) {
                // Shrinking: show tilted icon (flipped - tilts left)
                setBalanceIcon(CONFIG.images.balanceTilt, true);
            }
        }
        
        // Slider event listeners
        document.getElementById('startAmount').addEventListener('input', (e) => {
            const newValue = parseInt(e.target.value);
            document.getElementById('startAmountValue').textContent = newValue;
            
            // Only reset if value actually changed (prevent duplicate resets)
            if (typeof window.stateManager !== 'undefined') {
                const currentSavings = window.stateManager.get('totalSavings');
                // Only reset if the starting amount differs from current savings
                // (indicating this is a user slider move, not a balance button click that already reset)
                if (currentSavings !== newValue) {
                    window.stateManager.reset(newValue);
                }
            } else if (typeof window.initializeFromStartingAmount === 'function') {
                // Fallback for backwards compatibility
                window.initializeFromStartingAmount();
            }
            
            checkBalance();
        });
        
        document.getElementById('inflation').addEventListener('input', (e) => {
            document.getElementById('inflationValue').textContent = e.target.value;
            checkBalance();
        });
        
        document.getElementById('savings').addEventListener('input', (e) => {
            document.getElementById('savingsValue').textContent = e.target.value;
            checkBalance();
        });
        
        // Button event listeners
        document.getElementById('restartButton').addEventListener('click', () => {
            if (typeof window.stateManager !== 'undefined') {
                window.stateManager.reset();
            } else if (typeof window.resetPigFill === 'function') {
                // Fallback for backwards compatibility
                window.resetPigFill();
            }
        });
        
        document.getElementById('pauseButton').addEventListener('click', () => {
            if (typeof window.stateManager !== 'undefined') {
                const isPaused = window.stateManager.togglePause();
                // Reset lastDropTime to prevent burst of drops on resume
                if (!isPaused) {
                    window.stateManager.updateLastDropTime(performance.now());
                }
                // UI update happens automatically via isPaused subscription
            } else if (typeof window.togglePause === 'function') {
                // Fallback for backwards compatibility
                window.togglePause();
            }
        });
        
        // Balance button for Starting Amount
        document.getElementById('balanceStartAmount').addEventListener('click', () => {
            const monthlySavings = parseInt(document.getElementById('savings').value);
            const annualInflationPercent = parseFloat(document.getElementById('inflation').value);
            
            const calculatedAmount = calculateBalancedStartAmount(monthlySavings, annualInflationPercent);
            
            // Set all buttons to balanced icon immediately (no flip)
            setBalanceIcon(CONFIG.images.balance, false);
            
            // Set the slider value
            const startAmountSlider = document.getElementById('startAmount');
            startAmountSlider.value = calculatedAmount;
            
            // Trigger input event to update settingsCache and display
            startAmountSlider.dispatchEvent(new Event('input', { bubbles: true }));
            
            // IMPORTANT: Reset state manager with calculated value directly
            // Don't rely on settingsCache being updated yet (race condition)
            if (typeof window.stateManager !== 'undefined') {
                window.stateManager.reset(calculatedAmount);
            }
        });
        
        // Balance button for Monthly Savings
        document.getElementById('balanceSavings').addEventListener('click', () => {
            const startingAmount = parseInt(document.getElementById('startAmount').value);
            const annualInflationPercent = parseFloat(document.getElementById('inflation').value);
            
            const calculatedSavings = calculateBalancedSavings(startingAmount, annualInflationPercent);
            
            // Set all buttons to balanced icon immediately (no flip)
            setBalanceIcon(CONFIG.images.balance, false);
            
            // Set the slider value
            const savingsSlider = document.getElementById('savings');
            savingsSlider.value = calculatedSavings;
            
            // Trigger input event to update settingsCache
            savingsSlider.dispatchEvent(new Event('input', { bubbles: true }));
            
            // Display value is updated by the input event listener
        });
        
        // Balance button for Inflation
        document.getElementById('balanceInflation').addEventListener('click', () => {
            const startingAmount = parseInt(document.getElementById('startAmount').value);
            const monthlySavings = parseInt(document.getElementById('savings').value);
            
            const calculatedInflation = calculateBalancedInflation(startingAmount, monthlySavings);
            
            // Set all buttons to balanced icon immediately (no flip)
            setBalanceIcon(CONFIG.images.balance, false);
            
            // Set the slider value
            const inflationSlider = document.getElementById('inflation');
            inflationSlider.value = calculatedInflation;
            
            // Trigger input event to update settingsCache
            inflationSlider.dispatchEvent(new Event('input', { bubbles: true }));
            
            // Display value is updated by the input event listener
        });
        
        // Set initial state on page load (check if balanced)
        document.addEventListener('DOMContentLoaded', () => {
            checkBalance();
        });
    </script>
    
    <!-- 6. Animation Logic - uses all above modules -->
    <script src="ppl-animation.js"></script>
</body>
</html>
